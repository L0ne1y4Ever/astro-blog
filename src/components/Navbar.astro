---
import { ui } from '@/i18n/ui'
import { getPageInfo } from '@/utils/page'

const { currentLang, isHome, isPost, isTag, isAbout, isSearch, isArchive, isLinks, getLocalizedPath } = getPageInfo(Astro.url.pathname)
const currentUI = ui[currentLang as keyof typeof ui] ?? {}

const isPostActive = isHome || isPost
const isTagActive = isTag
const isAboutActive = isAbout
const isSearchActive = isSearch
const isArchiveActive = isArchive
const isLinksActive = isLinks
const isMoreActive = isSearchActive || isArchiveActive || isLinksActive

function getNavItemClass(isActive: boolean) {
  return isActive
    ? 'highlight-static c-primary font-bold after:bottom-0.7em'
    : 'highlight-hover transition-[colors,font-weight] after:bottom-0.7em hover:(c-primary font-bold)'
}

const navItems = [
  {
    href: '/',
    label: currentUI.posts,
    className: getNavItemClass(isPostActive),
  },
  {
    href: '/tags/',
    label: currentUI.tags,
    className: getNavItemClass(isTagActive),
  },
  {
    href: '/about/',
    label: currentUI.about,
    className: getNavItemClass(isAboutActive),
  },
]

const moreItems = [
  {
    href: '/search/',
    label: currentUI.search,
    className: getNavItemClass(isSearchActive),
    type: 'search',
  },
  {
    href: '/archive/',
    label: currentUI.archive,
    className: getNavItemClass(isArchiveActive),
  },
  {
    href: '/links/',
    label: currentUI.links,
    className: getNavItemClass(isLinksActive),
  },
]
---

<nav
  aria-label="Site Navigation"
  data-mode={isMoreActive ? 'more' : 'main'}
  class:list={[
    'mb-10.5 text-3.6 font-semibold leading-2.45em font-navbar',
    'lg:(uno-desktop-column text-4 bottom-[min(9.04rem+3.85vw,12.5rem)]) cjk:tracking-wide',
    isPost ? 'hidden lg:block' : '',
  ]}
>
  <ul>
    {navItems.map(item => (
      <li class="nav-primary-item">
        <a
          href={getLocalizedPath(item.href)}
          class={item.className}
        >
          {item.label}
        </a>
      </li>
    ))}
    <li>
      <details
        class="nav-more-details"
        open={isMoreActive}
      >
        <summary
          class:list={[
            getNavItemClass(isMoreActive),
            'nav-more-summary cursor-pointer select-none',
          ]}
        >
          {currentUI.more}
        </summary>
        <ul
          class:list={[
            'nav-more-list mt-1.5 pl-3 space-y-1.5',
            isMoreActive ? 'pl-0 space-y-1' : '',
          ]}
        >
          {moreItems.map(item => (
            <li>
              {item.type === 'search'
                ? (
                    <button
                      type="button"
                      data-search-open
                      class={`nav-search-button ${item.className}`}
                    >
                      {item.label}
                    </button>
                  )
                : (
                    <a
                      href={getLocalizedPath(item.href)}
                      class={item.className}
                    >
                      {item.label}
                    </a>
                  )}
            </li>
          ))}
        </ul>
      </details>
    </li>
  </ul>
</nav>

<script is:inline data-astro-rerun>
  (function () {
    function initNavMoreToggle() {
      const nav = document.querySelector('nav[aria-label="Site Navigation"]')
      if (!nav) return
      const details = nav.querySelector('.nav-more-details')
      if (!details) return

      const updateMode = () => {
        nav.dataset.mode = details.open ? 'more' : 'main'
      }

      updateMode()

      if (details.dataset.navBound !== '1') {
        details.dataset.navBound = '1'
        details.addEventListener('toggle', updateMode)
      }
    }

    document.addEventListener('astro:page-load', initNavMoreToggle)
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initNavMoreToggle)
    }
    else {
      initNavMoreToggle()
    }
  })()
</script>

<style>
  .nav-primary-item {
    max-height: 3.2em;
    opacity: 1;
    transform: translateY(0);
    overflow: hidden;
    transition: max-height 260ms ease, opacity 200ms ease, transform 260ms ease;
  }

  nav[data-mode='more'] .nav-primary-item {
    max-height: 0;
    opacity: 0;
    transform: translateY(-0.35em);
    pointer-events: none;
  }

  .nav-more-details > .nav-more-list {
    max-height: 0;
    opacity: 0;
    transform: translateY(-0.35em);
    overflow: hidden;
    transition: max-height 280ms ease, opacity 220ms ease, transform 280ms ease;
  }

  .nav-more-details[open] > .nav-more-list {
    max-height: 12rem;
    opacity: 1;
    transform: translateY(0);
  }

  @supports selector(:has(*)) {
    nav:has(.nav-more-details[open]) .nav-primary-item {
      max-height: 0;
      opacity: 0;
      transform: translateY(-0.35em);
      pointer-events: none;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .nav-primary-item,
    .nav-more-details > .nav-more-list {
      transition: none;
    }
  }

  .nav-search-button {
    background: none;
    border: none;
    padding: 0;
    font: inherit;
    color: inherit;
    cursor: pointer;
  }

  :global(html.reduce-motion) .nav-primary-item,
  :global(html.reduce-motion) .nav-more-details > .nav-more-list {
    transition: none;
  }

  .nav-more-list li + li {
    margin-top: 0.25rem !important;
  }

  /* 2. 关键：缩小选项本身的行高 */
  /* 导航栏默认是 2.45em，对于下拉列表来说太高了 */
  .nav-more-list a,
  .nav-more-list button {
    line-height: 1.4 !important; /* 缩小行高，让文字更紧凑 */
    padding-top: 0.2rem;
    padding-bottom: 0.2rem;
    display: inline-block; /* 确保 padding 和 margin 生效 */
  }
  /* 如果你想调整“更多”按钮与下方第一个选项的距离 */
  .nav-more-list {
    margin-top: -1rem !important; 
  }
</style>
