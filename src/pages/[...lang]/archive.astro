---
import { allLocales } from '@/config'
import { getLangFromLocale, getLangRouteParam } from '@/i18n/lang'
import { getPostPath, getTagPath } from '@/i18n/path'
import Layout from '@/layouts/Layout.astro'
import { getPostsByYear } from '@/utils/content'

export async function getStaticPaths() {
  return allLocales.map(lang => ({
    params: { lang: getLangRouteParam(lang) },
  }))
}

const currentLang = getLangFromLocale(Astro.currentLocale)
const postsByYear = await getPostsByYear(currentLang)

const allPosts = Array.from(postsByYear.values()).flat()
const totalPosts = allPosts.length
const totalWords = allPosts.reduce((sum, post) => sum + countWords(post.body ?? ''), 0)

const currentYear = new Date().getFullYear()
const currentAge = 19

const categoryFilters = [
  {
    label: '杂谈',
    value: '杂谈',
    icon: '<svg viewBox="0 0 20 20" aria-hidden="true"><path fill="none" stroke="currentColor" stroke-width="1.5" d="M4 5.5h12a2 2 0 0 1 2 2v6.5a2 2 0 0 1-2 2H8l-4 3v-3H4a2 2 0 0 1-2-2V7.5a2 2 0 0 1 2-2Z"/></svg>',
  },
  {
    label: '代码日常',
    value: '代码日常',
    icon: '<svg viewBox="0 0 20 20" aria-hidden="true"><path fill="none" stroke="currentColor" stroke-width="1.5" d="m7.5 6-4 4 4 4M12.5 6l4 4-4 4M9 15.5l2-11"/></svg>',
  },
  {
    label: '碎碎念',
    value: '碎碎念',
    icon: '<svg viewBox="0 0 20 20" aria-hidden="true"><path fill="none" stroke="currentColor" stroke-width="1.5" d="M3.5 6.5h13M3.5 10h13M3.5 13.5h9"/></svg>',
  },
  {
    label: '生活随笔',
    value: '生活随笔',
    icon: '<svg viewBox="0 0 20 20" aria-hidden="true"><path fill="none" stroke="currentColor" stroke-width="1.5" d="M10 3.5c3.5 2.2 4.5 6.2 2.8 9.1C11 15.5 7.5 16.5 5.5 14c2.7 0 4.8-1.2 5.7-3.1 1-2.2.3-4.8-1.2-6.3Z"/></svg>',
  },
  {
    label: '项目复盘',
    value: '项目复盘',
    icon: '<svg viewBox="0 0 20 20" aria-hidden="true"><path fill="none" stroke="currentColor" stroke-width="1.5" d="M6 3.5h8l2 2V16a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 4 16V5a2 2 0 0 1 2-1.5Z"/><path fill="none" stroke="currentColor" stroke-width="1.5" d="M7.5 8.5h5M7.5 12h5"/></svg>',
  },
]

function formatMonthDay(date: Date) {
  return date.toLocaleDateString('en-US', {
    month: '2-digit',
    day: '2-digit',
  })
}

function countWords(text: string) {
  return text
    .replace(/```[\s\S]*?```/g, '')
    .replace(/`[^`]*`/g, '')
    .replace(/<[^>]*>/g, '')
    .replace(/!\[[^\]]*\]\([^)]*\)/g, '')
    .replace(/\[[^\]]*\]\([^)]*\)/g, '')
    .replace(/[\\#>*_~\-]/g, '')
    .replace(/\s+/g, '')
    .length
}

function formatWordCount(count: number) {
  if (count >= 10000) {
    const value = Math.round((count / 10000) * 100) / 100
    return `${value}万字`
  }
  return `${count}字`
}

function getAgeForYear(year: number) {
  return `${currentAge - (currentYear - year)}岁`
}
---

<Layout>
  <div data-archive-root>
    <section class="archive-toolbar font-navbar">
      <div class="archive-toolbar-left">
        <details class="archive-filter-dropdown" data-filter-dropdown>
          <summary class="archive-filter-trigger" role="button" aria-label="全部分类">
            <span class="archive-filter-icon" aria-hidden="true">
              <svg viewBox="0 0 20 20"><path fill="none" stroke="currentColor" stroke-width="1.5" d="M4.5 5.5h11a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H7.5l-3.5 3v-3h-0.5a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2Z" /></svg>
            </span>
            <span class="archive-filter-label">全部分类</span>
            <span class="archive-filter-caret" aria-hidden="true">
              <svg viewBox="0 0 20 20"><path fill="none" stroke="currentColor" stroke-width="1.5" d="m5.5 8 4.5 4.5L14.5 8" /></svg>
            </span>
          </summary>

          <div class="archive-filter-menu" role="listbox" aria-label="分类列表">
            <button class="archive-filter-option is-active" type="button" data-filter="all" role="option" aria-selected="true">
              <span class="archive-filter-icon" aria-hidden="true">
                <svg viewBox="0 0 20 20"><path fill="none" stroke="currentColor" stroke-width="1.5" d="M4.5 5.5h11a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H7.5l-3.5 3v-3h-0.5a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2Z" /></svg>
              </span>
              全部分类
            </button>

            {categoryFilters.map(category => (
              <button class="archive-filter-option" type="button" data-filter={category.value} role="option" aria-selected="false">
                <span class="archive-filter-icon" aria-hidden="true" set:html={category.icon} />
                {category.label}
              </button>
            ))}
          </div>
        </details>

        <button class="archive-filter-plain" type="button" data-sort-button aria-label="切换排序字段">
          <span class="archive-filter-icon" aria-hidden="true">
            <svg viewBox="0 0 20 20"><path fill="none" stroke="currentColor" stroke-width="1.5" d="M5 4.5v2M15 4.5v2M4 8.5h12M5.5 11h3M11.5 11h3M5.5 14h3" /></svg>
          </span>
          <span class="archive-sort-label">创建日期</span>
        </button>
      </div>

      <div class="archive-summary">
        <span>{formatWordCount(totalWords)}</span>
        <span class="archive-summary-divider">·</span>
        <span>{totalPosts} 篇</span>
      </div>
    </section>

    <div class="archive-years">
      {[...postsByYear.entries()].map(([year, posts]) => {
        const yearWords = posts.reduce((sum, post) => sum + countWords(post.body ?? ''), 0)
        const yearStats = `${formatWordCount(yearWords)} · ${posts.length}篇`
        const yearAge = getAgeForYear(year)

        return (
          <section class="archive-year" data-year={year}>
            <div class="archive-year-watermark archive-year-watermark--year year-watermark font-title">{year}</div>

            <div class="archive-year-watermark archive-year-watermark--age year-watermark font-title" aria-live="polite">
              <span class="archive-year-age">{yearAge}</span>
              <span class="archive-year-stats">{yearStats}</span>
            </div>

            <ul class="archive-list">
              {posts.map((post) => {
                const slug = post.data.abbrlink || post.id
                const tags = post.data.tags ?? []
                const categories = post.data.categories ?? []

                return (
                  <li
                    class="archive-item"
                    data-tags={tags.join(',')}
                    data-categories={categories.join(',')}
                    data-created={post.data.published.valueOf()}
                    data-updated={(post.data.updated ?? post.data.published).valueOf()}
                  >
                    <time class="archive-date font-time" datetime={post.data.published.toISOString().split('T')[0]}>
                      {formatMonthDay(post.data.published)}
                    </time>

                    <a class="archive-title" href={getPostPath(slug, currentLang)}>
                      {post.data.title}
                    </a>

                    <div class="archive-tags">
                      {tags.map(tag => (
                        <a class="archive-tag" href={getTagPath(tag, currentLang)}>
                          # {tag}
                        </a>
                      ))}
                    </div>
                  </li>
                )
              })}
            </ul>
          </section>
        )
      })}
    </div>
  </div>
</Layout>

<script is:inline data-astro-rerun>
(function () {
  function initArchiveInteractions() {
    const root = document.querySelector('[data-archive-root]')
    if (!root) return

    const filterDropdown = root.querySelector('[data-filter-dropdown]')
    const sortButton = root.querySelector('[data-sort-button]')
    const filterLabel = root.querySelector('.archive-filter-label')
    const sortLabel = root.querySelector('.archive-sort-label')
    const filterButtons = Array.from(root.querySelectorAll('.archive-filter-option[data-filter]'))
    const items = Array.from(root.querySelectorAll('.archive-item'))
    const years = Array.from(root.querySelectorAll('.archive-year'))
    const yearsContainer = root.querySelector('.archive-years')

    const originalYearOrder = years.slice()
    const originalItemsMap = new Map()
    let currentSortKey = 'created'

    years.forEach((year) => {
      originalItemsMap.set(year, Array.from(year.querySelectorAll('.archive-item')))
    })

    const getKeyTime = (item, key) => {
      const value = key === 'updated' ? item.dataset.updated : item.dataset.created
      const time = Number(value)
      return Number.isFinite(time) ? time : 0
    }

    const applySort = (key) => {
      currentSortKey = key
      if (!yearsContainer) return

      if (sortLabel) {
        sortLabel.textContent = key === 'updated' ? '更新日期' : '创建日期'
      }

      const yearOrderIndex = new Map(originalYearOrder.map((year, index) => [year, index]))
      const yearEntries = years.map((year) => {
        const list = year.querySelector('.archive-list')
        const itemsInYear = originalItemsMap.get(year) || []
        const orderedItems = itemsInYear
          .slice()
          .sort((a, b) => getKeyTime(b, key) - getKeyTime(a, key))

        orderedItems.forEach(item => list.appendChild(item))

        const visibleItems = orderedItems.filter(item => !item.classList.contains('is-hidden'))
        const maxTime = visibleItems.length > 0
          ? Math.max(...visibleItems.map(item => getKeyTime(item, key)))
          : -1

        return { year, maxTime, index: yearOrderIndex.get(year) ?? 0 }
      })

      yearEntries
        .sort((a, b) => (b.maxTime - a.maxTime) || (a.index - b.index))
        .forEach(entry => yearsContainer.appendChild(entry.year))
    }

    const applyFilter = (filter) => {
      filterButtons.forEach((button) => {
        const isActive = button.dataset.filter === filter
        button.classList.toggle('is-active', isActive)
        button.setAttribute('aria-selected', isActive ? 'true' : 'false')

        if (isActive && filterLabel) {
          filterLabel.textContent = button.textContent?.trim() || '全部分类'
        }
      })

      items.forEach((item) => {
        const categories = (item.dataset.categories || '').split(',').filter(Boolean)
        const match = filter === 'all' || categories.includes(filter)
        item.classList.toggle('is-hidden', !match)
        item.setAttribute('aria-hidden', match ? 'false' : 'true')
      })

      years.forEach((year) => {
        year.classList.remove('is-active')
        const visibleItems = year.querySelectorAll('.archive-item:not(.is-hidden)')
        year.classList.toggle('is-hidden', visibleItems.length === 0)
      })

      applySort(currentSortKey)
    }

    filterButtons.forEach((button) => {
      button.addEventListener('click', () => {
        applyFilter(button.dataset.filter || 'all')
        if (filterDropdown) filterDropdown.removeAttribute('open')
      })
    })

    if (sortButton) {
      sortButton.addEventListener('click', () => {
        applySort(currentSortKey === 'created' ? 'updated' : 'created')
      })
    }

    years.forEach((year) => {
      const yearItems = year.querySelectorAll('.archive-item')
      yearItems.forEach((item) => {
        item.addEventListener('mouseenter', () => year.classList.add('is-active'))
        item.addEventListener('mouseleave', () => year.classList.remove('is-active'))
        item.addEventListener('focusin', () => year.classList.add('is-active'))
        item.addEventListener('focusout', (event) => {
          if (!year.contains(event.relatedTarget)) year.classList.remove('is-active')
        })
      })
    })

    applyFilter('all')
  }

  document.addEventListener('astro:page-load', initArchiveInteractions)
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initArchiveInteractions)
  } else {
    initArchiveInteractions()
  }
})()
</script>

<style>
  :root {
    /* 控件统一高度（更紧凑就改成 1.75rem / 1.85rem） */
    --archive-control-h: 1.85rem;
  }

  /* ===== 顶部工具栏 ===== */
  .archive-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1.2rem;
    margin-bottom: 2.5rem;
  }

  .archive-toolbar-left {
    display: flex;
    align-items: center;
    flex-wrap: nowrap;
    gap: 0.45rem;
    font-size: 0.9rem;
    color: oklch(var(--un-preset-theme-colors-secondary) / 0.75);
  }

  .archive-summary {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
    color: oklch(var(--un-preset-theme-colors-secondary) / 0.6);
    white-space: nowrap;
  }

  .archive-summary-divider {
    opacity: 0.6;
  }

  /* ===== 控件（summary/button）统一盒模型，避免不齐高 ===== */
  .archive-filter-dropdown {
    position: relative;
    display: inline-flex;
    align-items: stretch;
    height: var(--archive-control-h);
  }

  .archive-filter-trigger,
  .archive-filter-plain {
    box-sizing: border-box;
    height: var(--archive-control-h);
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;

    padding: 0 0.5rem;
    border-radius: 0.55rem;
    border: 1px solid transparent; /* 保证 hover 时不“长高” */
    background: transparent;
    color: inherit;
    cursor: pointer;

    letter-spacing: 0.02em;
    line-height: 1;
    margin: 0;
    user-select: none;
    transition: color 180ms ease, background-color 180ms ease, border-color 180ms ease;
  }

  .archive-filter-trigger {
    height: 100%;
    list-style: none;
  }

  .archive-filter-trigger::-webkit-details-marker {
    display: none;
  }

  .archive-filter-plain:hover,
  .archive-filter-trigger:hover {
    color: oklch(var(--un-preset-theme-colors-primary) / 0.9);
    background-color: oklch(var(--un-preset-theme-colors-secondary) / 0.08);
    border-color: oklch(var(--un-preset-theme-colors-secondary) / 0.18);
  }

  .archive-filter-icon {
    width: 0.95rem;
    height: 0.95rem;
    display: inline-flex;
    align-items: center;
  }

  .archive-filter-icon svg {
    width: 0.95rem;
    height: 0.95rem;
  }

  .archive-filter-caret {
    margin-left: 0.15rem;
    opacity: 0.6;
    transition: transform 180ms ease;
  }

  .archive-filter-dropdown[open] .archive-filter-caret {
    transform: rotate(180deg);
  }

  /* ===== 下拉菜单 ===== */
  .archive-filter-menu {
    position: absolute;
    top: 100%;
    margin-top: 0.12rem;
    left: 0;

    min-width: 11rem;
    max-height: 320px;
    overflow: auto;

    background: oklch(var(--un-preset-theme-colors-background) / 0.98);
    border: 1px solid oklch(var(--un-preset-theme-colors-secondary) / 0.2);
    border-radius: 0.75rem;
    padding: 0.28rem;

    box-shadow: 0 18px 40px oklch(0 0 0 / 0.35);
    display: grid;
    gap: 0.1rem;
    z-index: 20;
  }

  .archive-filter-dropdown[open] .archive-filter-menu {
    animation: archiveMenuIn 160ms ease-out;
    transform-origin: top left;
  }

  @keyframes archiveMenuIn {
    from {
      opacity: 0;
      transform: translateY(-0.35rem) scale(0.98);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  .archive-filter-option {
    display: flex;
    align-items: center;
    gap: 0.4rem;

    padding: 0.32rem 0.45rem;
    border-radius: 0.55rem;
    border: none;
    background: transparent;
    color: inherit;

    cursor: pointer;
    text-align: left;
    font-size: 0.88rem;
    line-height: 1.2;

    transition: background-color 180ms ease, color 180ms ease;
  }

  .archive-filter-option:hover,
  .archive-filter-option.is-active {
    background-color: oklch(var(--un-preset-theme-colors-secondary) / 0.12);
    color: oklch(var(--un-preset-theme-colors-primary) / 0.95);
  }

  .archive-filter-menu::-webkit-scrollbar {
    width: 8px;
  }

  .archive-filter-menu::-webkit-scrollbar-thumb {
    border: 2px solid transparent;
    background-clip: content-box;
    background: oklch(var(--un-preset-theme-colors-secondary) / 0.2);
    border-radius: 999px;
  }

  /* ===== 年份列表容器 ===== */
  .archive-years {
    display: flex;
    flex-direction: column;
  }

  .archive-year {
    position: relative;
    padding-top: 0;
    border-top: 1px solid oklch(var(--un-preset-theme-colors-secondary) / 0.15);
    transition: opacity 220ms ease, transform 220ms ease, max-height 220ms ease;
    max-height: 999px;
    overflow: hidden;
    margin-bottom: 3.6rem;
  }

  .archive-year:first-child {
    border-top: none;
  }

  .archive-year:last-child {
    margin-bottom: 0;
  }

  /* ===== 年份水印（年份/年龄） ===== */
  .archive-year-watermark {
    font-family: "Inter", sans-serif !important; 
    position: absolute;
    top: 0;
    font-weight: 700;
    letter-spacing: 0.001em;
    font-variant-numeric: tabular-nums;
    line-height: 1;

    color: oklch(var(--un-preset-theme-colors-secondary) / 0.3);
    opacity: 1;

    pointer-events: none;
    user-select: none;
    z-index: 0;

    /* 核心遮罩：从顶部到 75% 的位置完全显示(black)，最后 25% 快速淡出 */
    -webkit-mask-image: linear-gradient(
      to bottom,
      black 0%,
      black 75%,         /* 在 75% 之前都是完全清晰的 */
      rgba(0, 0, 0, 0.2) 100% /* 到底部时变得极淡 */
    );
    mask-image: linear-gradient(
      to bottom,
      black 0%,
      black 75%,
      rgba(0, 0, 0, 0.2) 100%
    );
    transition: color 220ms ease, -webkit-text-stroke-color 220ms ease;
  }

  @supports (-webkit-text-stroke: 1px black) {
    .archive-year-watermark {
      color: transparent;
      -webkit-text-stroke: 2px oklch(var(--un-preset-theme-colors-secondary) / 0.36);
    }
  }

  .archive-year-watermark--year {
    left: 0.5rem;
    font-size: clamp(1rem, 6.5vw, 5.2rem);
  }

  .archive-year-watermark--age {
    right: 0;
    text-align: right;
    min-width: 4ch;
    display: inline-grid;
    font-size: clamp(2.6rem, 6vw, 4.6rem);
  }

  /* 年龄 / 统计：叠在同一格，通过 is-active 切换 */
  .archive-year-age,
  .archive-year-stats {
    grid-area: 1 / 1;
    white-space: nowrap;
    transition: opacity 220ms ease, transform 220ms ease;
  }

  .archive-year-age {
    font-size: 1em;
    opacity: 1;
    transform: translateY(0);
  }

  .archive-year-stats {
    font-size: 0.35em;
    letter-spacing: 0.02em;
    opacity: 0;
    transform: translateY(0.35rem);
  }

  .archive-year.is-active .archive-year-watermark {
    color: oklch(var(--un-preset-theme-colors-primary) / 0.8);
    -webkit-text-stroke-color: transparent;
  }

  .archive-year.is-active .archive-year-age {
    opacity: 0;
    transform: translateY(-0.35rem);
  }

  .archive-year.is-active .archive-year-stats {
    opacity: 0.75;
    transform: translateY(65%);
  }

  /* ===== 文章列表 ===== */
  .archive-list {
    list-style: none;
    margin: 0;
    padding: clamp(3.2rem, 6vw, 4.2rem) 0 0;
    position: relative;
    z-index: 1;
  }

  .archive-item {
    display: grid;
    grid-template-columns: 3.6rem minmax(0, 1fr) auto;
    align-items: center;
    gap: 1rem;

    padding: 0.15rem 0.6rem;
    border-radius: 0.6rem;
    border: 1px solid transparent;

    max-height: 10rem;
    overflow: hidden;

    transition: background-color 180ms ease, border-color 180ms ease, transform 180ms ease,
      opacity 220ms ease, max-height 220ms ease, padding 220ms ease, margin 220ms ease;
  }

  .archive-item + .archive-item {
    margin-top: 0.15rem;
  }

  .archive-item:hover,
  .archive-item:focus-within {
    background-color: oklch(var(--un-preset-theme-colors-secondary) / 0.08);
    border-color: oklch(var(--un-preset-theme-colors-primary) / 0.25);
    transform: translateY(-1px);
  }

  .archive-item.is-hidden {
    opacity: 0;
    max-height: 0;
    padding-top: 0;
    padding-bottom: 0;
    margin-top: 0;
    margin-bottom: 0;
    border-color: transparent;
    transform: translateY(-0.4rem);
    pointer-events: none;
  }

  .archive-year.is-hidden {
    opacity: 0;
    max-height: 0;
    padding-top: 0;
    margin-top: 0;
    margin-bottom: 0;
    border-top-color: transparent;
    transform: translateY(-0.6rem);
    pointer-events: none;
  }

  .archive-date {
    font-family: "ui-monospace", "SF Mono", SFMono-Regular, Consolas, "Liberation Mono", Menlo, Courier, monospace !important;
    font-size: 1rem;
    color: oklch(var(--un-preset-theme-colors-secondary) / 0.9);
    letter-spacing: 0.09em;
  }

  .archive-title {
    font-family: "LXGW WenKai Screen", sans-serif !important;
    font-size: 1rem;
    font-weight: 600;
    color: oklch(var(--un-preset-theme-colors-primary) / 0.9);
    text-decoration: none;

    margin: 0 -0.2rem;
    letter-spacing: -0.01em;

    /* 防止挤压时标题把布局撑爆 */
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .archive-title:hover {
    color: oklch(var(--un-preset-theme-colors-primary) / 1);
  }

  .archive-tags {
    display: flex;
    flex-wrap: wrap;
    justify-content: flex-end;
    gap: 0.5rem;
    font-size: 0.85rem;
    color: oklch(var(--un-preset-theme-colors-secondary) / 0.5);
  }

  .archive-tag {
    text-decoration: none;
    color: inherit;
    transition: color 180ms ease, opacity 180ms ease;
  }

  .archive-item:hover .archive-tag,
  .archive-item:focus-within .archive-tag {
    color: oklch(var(--un-preset-theme-colors-secondary) / 0.75);
  }

  /* ===== 手机适配 ===== */
  @media (max-width: 768px) {
    .archive-toolbar {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.6rem;
    }

    .archive-toolbar-left {
      flex-wrap: wrap; /* 手机上允许换行，不挤 */
      gap: 0.45rem;
    }

    .archive-filter-menu {
      min-width: 10rem;
      max-height: 260px;
    }

    .archive-year-watermark {
      font-family: "Inter", sans-serif !important; 
      top: 0.2rem;
    }

    .archive-year-watermark--year {
      font-size: clamp(2.6rem, 14vw, 4rem);
    }

    .archive-year-watermark--age {
      font-size: clamp(2.2rem, 13vw, 3.6rem);
    }

    .archive-item {
      grid-template-columns: 3.2rem minmax(0, 1fr);
      gap: 0.6rem;
      row-gap: 0.3rem;
      padding: 0.1rem 0.5rem;
    }

    .archive-tags {
      grid-column: 1 / -1;
      justify-content: flex-start;
      padding-left: 3.2rem;
      gap: 0.35rem;
    }

    .archive-list {
      padding-top: 2.6rem;
    }
  }

  /* 减少动态：无动画 */
  @media (prefers-reduced-motion: reduce) {
    .archive-item,
    .archive-year,
    .archive-year-watermark,
    .archive-year-age,
    .archive-year-stats {
      transition: none;
    }
  }

  :global(html.reduce-motion) .archive-item,
  :global(html.reduce-motion) .archive-year,
  :global(html.reduce-motion) .archive-year-watermark,
  :global(html.reduce-motion) .archive-year-age,
  :global(html.reduce-motion) .archive-year-stats {
    transition: none;
  }
</style>
